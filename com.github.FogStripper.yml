app-id: com.github.FogStripper
runtime: org.kde.Platform
runtime-version: '6.8'
sdk: org.kde.Sdk
command: fogstripper-launcher.sh
finish-args:
  # Permissões necessárias
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri # Acesso à GPU
  - --filesystem=home # Acesso aos arquivos do usuário

build-options:
  build-args:
    - --share=network

modules:
  # 1. Dependências do sistema

  - name: potrace
    buildsystem: autotools
    sources:
      - type: archive
        url: https://potrace.sourceforge.net/download/1.16/potrace-1.16.tar.gz
        sha256: be8248a17dedd6ccbaab2fcc45835bb0502d062e40fbded3bc56028ce5eb7acc

  # 2. Módulo Python principal que constrói o venv unificado
  - name: fogstripper-python-venv
    buildsystem: simple
    build-commands:
      # --- Criação e Instalação do Venv Unificado ---
      - python3 -m venv /app/venv
      - /app/venv/bin/pip install --no-cache-dir --upgrade pip setuptools wheel

      # PyTorch CPU (Flatpak nao tem acesso ao CUDA do host)
      - /app/venv/bin/pip install --no-cache-dir torch torchvision --index-url https://download.pytorch.org/whl/cpu

      # Instalação das dependências gerais
      - /app/venv/bin/pip install --no-cache-dir -r requirements.txt

      # --- Copiando os arquivos da aplicação ---
      - mkdir -p /app/bin
      - mkdir -p /app/src
      - cp -r src/* /app/src/
      - cp -r assets /app/assets

      # Launcher script
      - cp fogstripper-launcher.sh /app/bin/
      - chmod +x /app/bin/fogstripper-launcher.sh

      # --- Gerando o config.json para o ambiente Flatpak ---
      - |
        cat > "/app/src/config.json" << EOL
        {
            "PYTHON_REMBG": "/app/venv/bin/python3",
            "PYTHON_UPSCALE": "/app/venv/bin/python3",
            "REMBG_SCRIPT": "/app/src/workers/worker_rembg.py",
            "UPSCALE_SCRIPT": "/app/src/workers/worker_upscale.py",
            "EFFECTS_SCRIPT": "/app/src/workers/worker_effects.py",
            "BACKGROUND_SCRIPT": "/app/src/workers/worker_background.py"
        }
        EOL
    sources:
      - type: dir
        path: . # O diretório atual do projeto
